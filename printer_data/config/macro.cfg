[gcode_macro CG28]
gcode:
    {% if "x" not in printer.toolhead.homed_axes or "y" not in printer.toolhead.homed_axes or "z" not in printer.toolhead.homed_axes %}
    G28
    {% endif %}

#####################################################################
# Startcode f√ºr PLA
#####################################################################
[gcode_macro PRINT_START]
gcode:
    SAVE_GCODE_STATE NAME=start
    M140 S{params.BED}
    M190 S{params.BED}
    M104 S{params.EXTRUDER}
    M109 S{params.EXTRUDER}
    G92 E0.0
    STATUS_HOMING
    CG28 
    SET_PRESSURE_ADVANCE ADVANCE=0.020          ; EXTRUDR ASA
    M83                                ; Make the E relative independant of other axis
    RESTORE_GCODE_STATE NAME=start
    STATUS_PRINT
    SET_GCODE_OFFSET Z=-0.04
    M117 Purge Line
    G90                             ; relative positioning
    G1 Z10 F3000                    ; move nozzle away from bed
    G0 Y0 X10 F5000                ; go to the front of the bed
    G1 Z0.3 F500.0                  ; lower nozzle
    G92 E0.0                        ; Set E axis to 0.0    
    G1 X55 E24.0 F1000.0            ; intro line
    G1 Z5 F3000                    ; lift print head up again  (helps with goops)
   

    


[gcode_macro PRINT_END]
gcode:
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-10.0 F1600                ; retract filament
    G91                            ; relative positioning
    G0 Z8 F2000    ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G1 Z8 F3000                    ; move nozzle up 2mm
    G90                            ; absolute positioning
    G0 X60 Y110 F3600            ; park nozzle at rear
    M84                            ; disable stepper
 


[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    ##### set defaults #####
    {% set x = params.X|default(50) %}      #edit to your park position
    {% set y = params.Y|default(50) %}      #edit to your park position
    {% set z = params.Z|default(10)|float %} #edit to your park position
    {% set e = params.E|default(0.5) %}        #edit to your retract length
    ##### calculate save lift position #####
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% set lift_z = z|abs %}
    {% if act_z < (max_z - lift_z) %}
        {% set z_safe = lift_z %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}
    ##### end of definitions #####
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-{e} F2100
    G1 Z{z_safe}
    G90
    G1 X{x} Y{y} F6000


[gcode_macro RESUME]
rename_existing: BASE_RESUME
gcode:
    ##### set defaults #####
    {% set e = params.E|default(0.5) %} #edit to your retract length
    G91
    G1 E{e} F2100
    G90
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    BASE_RESUME

[pause_resume]


[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity %}
    SAVE_GCODE_STATE NAME=unload_state
    G91
    M300 # beep
    G92 E0
    G1 E25 F{speed} # purge
    G1 E-100 F{max_velocity} # fast-unload
    M300
    M300
    RESTORE_GCODE_STATE NAME=unload_state


[gcode_macro LOAD_FILAMENT]
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity %}
    SAVE_GCODE_STATE NAME=load_state
    M300 # beep
    G91
    G92 E0
    G1 E100 F{max_velocity} # fast-load
    G1 E25 F{speed} # purge
    M300
    M300
    RESTORE_GCODE_STATE NAME=load_state



[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[gcode_macro UNSAFE_BED_DOWN]
description: Lower the bed 50mm without homing
gcode:
  G90
  SET_KINEMATIC_POSITION Z=0
  G0 Z50 F600
  M84